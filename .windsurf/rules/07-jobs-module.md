---
trigger: manual
description:
globs:
---

## 1) Database Design (Supabase)

Table: `public.jobs`
- `id` bigint identity PK
- `deal_id` bigint → `public.deals(id)` ON DELETE SET NULL
- `property_id` bigint → `public.properties(id)` ON DELETE CASCADE
- `assigned_to_id` uuid → `public.sales(id)` ON DELETE SET NULL
- `status` job_status enum (default 'Unscheduled')
- `scheduled_at` timestamptz
- `completed_at` timestamptz
- `notes` text
- `created_at` timestamptz default now()

Enum: `public.job_status`
- Values: 'Unscheduled' | 'Scheduled' | 'In Progress' | 'Completed' | 'Cancelled'

Indexes:
- `idx_jobs_status(status)`
- `idx_jobs_assigned_to_id(assigned_to_id)`
- `idx_jobs_property_id(property_id)`

RLS:
- Enable RLS on `public.jobs`
- Read for all authenticated users
- Full access for the assigned user (`assigned_to_id = auth.uid()`)
- Optional: add role-based admin policies later

Migration file: `supabase/migrations/YYYYMMDDHHMMSS_jobs_module.sql`

Reference SQL:
```sql
-- Enum
CREATE TYPE public.job_status AS ENUM (
  'Unscheduled','Scheduled','In Progress','Completed','Cancelled'
);

-- Table
CREATE TABLE public.jobs (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  deal_id bigint REFERENCES public.deals(id) ON DELETE SET NULL,
  property_id bigint REFERENCES public.properties(id) ON DELETE CASCADE,
  assigned_to_id uuid REFERENCES public.sales(id) ON DELETE SET NULL,
  status public.job_status NOT NULL DEFAULT 'Unscheduled',
  scheduled_at timestamptz,
  completed_at timestamptz,
  notes text,
  created_at timestamptz NOT NULL DEFAULT now()
);

-- Indexes
CREATE INDEX idx_jobs_status ON public.jobs(status);
CREATE INDEX idx_jobs_assigned_to_id ON public.jobs(assigned_to_id);
CREATE INDEX idx_jobs_property_id ON public.jobs(property_id);

-- RLS
ALTER TABLE public.jobs ENABLE ROW LEVEL SECURITY;
CREATE POLICY jobs_read_authenticated ON public.jobs FOR SELECT
  USING (auth.role() = 'authenticated');
CREATE POLICY jobs_self_manage ON public.jobs FOR ALL
  USING (assigned_to_id = auth.uid());
```

Apply migration:
- Preferred: MCP apply_migration tool (does not require local `supabase link`)
- Alternative: `npx supabase db push` (only if CLI is linked)

---

## 2) Frontend: Resource & Pages (React-Admin)

Dependencies (Calendar view):
```bash
npm install @fullcalendar/core @fullcalendar/react @fullcalendar/daygrid @fullcalendar/timegrid @fullcalendar/interaction
```

Files to add under `src/jobs/`:
- `index.ts`: export list/create/edit/show
- `JobInputs.tsx`: shared form (deal/property/assigned/status/datetime/notes)
- `JobCreate.tsx`: `<Create><SimpleForm>…` using `JobInputs`
- `JobEdit.tsx`: `<Edit><SimpleForm>…` using `JobInputs`
- `JobShow.tsx`: read-only fields + links to deal/property
- `JobList.tsx` (Calendar): `useGetList` to fetch jobs; render `FullCalendar` (day/week/month). Map job → event: title = deal/property name; start = `scheduled_at`. On drag/drop (optional v1.1): call `dataProvider.update` to persist `scheduled_at`.

Register Resource in `src/root/CRM.tsx`:
```tsx
import CalendarMonthIcon from '@mui/icons-material/CalendarMonth';
import * as jobs from '../jobs';
// … inside <Admin>
<Resource name="jobs" {...jobs} icon={CalendarMonthIcon} />
```

Form Inputs (JobInputs.tsx):
- `ReferenceInput` + `AutocompleteInput` for `deal_id` (reference `deals`)
- `ReferenceInput` + `AutocompleteInput` for `property_id` (reference `properties`)
- `ReferenceInput` + `AutocompleteInput` for `assigned_to_id` (reference `sales`)
- `SelectInput` for `status` with enum choices
- `DateTimeInput` for `scheduled_at`
- `TextInput`/`RichTextInput` for `notes`

Visual design:
- Use theme tokens; no hard-coded colors
- Use `Paper`/`Card` with `theme.shadows[2]`, 12–16px radius
- Respect density and typography per rules

---

## 3) Deal → Job Handoff

Goal: From a Won deal, allow creating a job with prefilled fields.

Implementation:
- Add a `Create Job` button in `DealShow` actions bar, visible when the deal stage/category indicates "Won".
- Redirect to `/jobs/create` with prefilled record via React Router state:
```tsx
redirect('/jobs/create', { state: { record: { deal_id: record.id, property_id: record.property_id } } });
```
- In `JobCreate`, merge `location.state?.record` into default values

Optional: Add a `ReferenceManyField` on `DealShow` to list related jobs.

---

## 4) Data Provider & Views

- No provider changes expected. `jobs` is a standard table.
- For Calendar `getList`, filter by date range if needed (e.g., `scheduled_at@gte` / `@lte`). Our Supabase adapter supports basic filters; if needed, add a server-side view later.

---

## 5) Testing (per 03-testing.mdc)

Unit:
- `JobInputs` renders required fields; status choices present
- Default values applied from router state

Integration (RTL):
- Creating a job posts required payload and navigates to list
- Edit updates `scheduled_at`

Manual Smoke:
- Create job from a Won deal (prefilled)
- Job appears on Calendar on the scheduled date
- (v1.1) Drag-drop to reschedule updates `scheduled_at`

---

## 6) Deployment

- DB: apply migration via MCP tool (`apply_migration`)
- Frontend: `npm run build` + deploy per `04-deployment.mdc`
- Post-deploy QA: create job, view on calendar, edit, verify RLS by logging in as assigned user

---

## 7) Acceptance Criteria

- Jobs table with RLS enforced
- Jobs resource visible in nav with Calendar list view
- Create/Edit/Show functional with validation
- From a Won deal, user can create a job with prefilled fields
- Scheduled job visible on Calendar for its date

---

## 8) Follow-Ups (Future Iterations)

- Crew management and multi-assign
- Recurring jobs and templates (e.g., weekly mowing)
- Route optimization/day planning
- Mobile-first job detail and completion workflow
- Notifications & reminders (email/SMS)