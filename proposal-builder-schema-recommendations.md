
# Proposal Builder Schema Recommendations for Elite Landscaping CRM

## Executive Summary

Based on the PandaDoc analysis and examination of the existing Elite Landscaping CRM database schema, this document provides specific database schema recommendations for implementing a world-class proposal builder system. The recommendations include proper image storage buckets, enhanced product management, and seamless integration with existing deals and line items.

## Current Schema Analysis

### Existing Tables Reviewed
- **companies**: Company management with logo storage (jsonb)
- **contacts**: Contact management with avatar storage (jsonb)  
- **deals**: Deal pipeline with contact_ids array and basic amount tracking
- **properties**: Service locations with photos_paths array and google_photos integration
- **jobs**: Scheduling system linked to deals and properties
- **products**: Enhanced with vendor, size, quantity tracking (from 20250818 migration)

### Existing Storage Buckets (Verified via Supabase MCP)
- **attachments**: Public bucket for general file attachments
- **products**: Public bucket for product images (already exists!)
- **property-photos**: Private bucket for property images
- **google-photos**: Private bucket for Google Photos integration

## Schema Recommendations

### 1. Products Table Enhancements

**New Columns Added:**
```sql
-- Proposal-specific enhancements
proposal_category text,           -- Groups products into proposal sections
is_proposal_visible boolean,      -- Hide/show in proposal catalog
proposal_description text,        -- Enhanced description for proposals
image_paths text[],              -- Array of image paths in product-images bucket
is_optional boolean,             -- Default optional status for client selection
sort_order integer               -- Default ordering in proposals
```

**Benefits:**
- **Catalog Organization**: Products grouped by proposal sections (Landscape Management, Installation Services, etc.)
- **Visibility Control**: Hide internal/discontinued products from client-facing proposals
- **Rich Content**: Enhanced descriptions and multiple images per product
- **Client Experience**: Default optional status for better client interaction

### 2. New Core Tables

#### A. Proposal Templates (`proposal_templates`)
**Purpose**: Reusable proposal structures and branding

```sql
CREATE TABLE public.proposal_templates (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL,
    description text,
    structure jsonb NOT NULL DEFAULT '{}',     -- Theme, layout, branding
    default_sections jsonb NOT NULL DEFAULT '[]', -- Section configuration
    is_active boolean DEFAULT true,
    is_default boolean DEFAULT false,
    created_by uuid REFERENCES auth.users(id),
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);
```

**Key Features:**
- **Branding Control**: Store Elite Landscaping theme colors, fonts, logos
- **Section Templates**: Pre-configured sections for different service types
- **Version Management**: Active/inactive templates with default selection

#### B. Proposals (`proposals`)
**Purpose**: Individual proposal instances linked to deals

```sql
CREATE TABLE public.proposals (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    deal_id bigint REFERENCES public.deals(id) ON DELETE CASCADE,
    template_id bigint REFERENCES public.proposal_templates(id),
    title text NOT NULL,
    status text DEFAULT 'draft',              -- draft, sent, viewed, accepted, rejected
    data jsonb NOT NULL DEFAULT '{}',         -- Complete proposal structure
    client_data jsonb DEFAULT '{}',           -- Client selections/customizations
    sections jsonb NOT NULL DEFAULT '[]',     -- Section visibility/ordering
    
    -- Pricing calculations
    subtotal decimal(10,2) DEFAULT 0,
    tax_rate decimal(5,4) DEFAULT 0.0825,     -- 8.25% Texas tax rate
    tax_amount decimal(10,2) DEFAULT 0,
    total_amount decimal(10,2) DEFAULT 0,
    deposit_amount decimal(10,2) DEFAULT 0,
    
    -- Client interaction tracking
    sent_at timestamptz,
    viewed_at timestamptz,
    first_viewed_at timestamptz,
    view_count integer DEFAULT 0,
    responded_at timestamptz,
    expires_at timestamptz,
    
    created_by uuid REFERENCES auth.users(id),
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);
```

**Key Features:**
- **Deal Integration**: Direct link to existing deals workflow
- **Client Tracking**: Monitor proposal views and interactions
- **Flexible Pricing**: Support for deposits, tax calculations, recurring services
- **Status Management**: Complete proposal lifecycle tracking

#### C. Proposal Line Items (`proposal_line_items`)
**Purpose**: Individual products/services within proposals with client controls

```sql
CREATE TABLE public.proposal_line_items (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    proposal_id bigint REFERENCES public.proposals(id) ON DELETE CASCADE,
    product_id bigint REFERENCES public.products(id) ON DELETE SET NULL,
    section_name text NOT NULL DEFAULT 'General',
    name text NOT NULL,
    description text,
    image_paths text[],                       -- Product images for this line item
    quantity decimal(10,2) NOT NULL DEFAULT 1,
    unit text DEFAULT 'each',
    unit_price decimal(10,2) NOT NULL,
    unit_cost decimal(10,2),                  -- Internal cost (hidden from client)
    total_price decimal(10,2) GENERATED ALWAYS AS (quantity * unit_price) STORED,
    total_cost decimal(10,2) GENERATED ALWAYS AS (quantity * unit_cost) STORED, -- Internal total cost
    
    -- Client-facing controls (PandaDoc-style)
    is_visible_to_client boolean DEFAULT true,    -- Show/hide from client
    is_optional boolean DEFAULT false,            -- Client can select/deselect
    is_selected_by_client boolean DEFAULT true,   -- Current client selection
    
    -- Organization
    sort_order integer DEFAULT 0,
    section_sort_order integer DEFAULT 0,
    
    custom_data jsonb DEFAULT '{}',
    created_at timestamptz NOT NULL DEFAULT now(),
    updated_at timestamptz NOT NULL DEFAULT now()
);
```

**Key Features:**
- **Section Organization**: Group line items into logical sections
- **Client Interaction**: Yellow checkbox functionality like PandaDoc
- **Cost Privacy**: Internal costs never visible to clients
- **Flexible Pricing**: Support for different units, quantities, custom pricing

### 3. Image Storage Strategy

#### Storage Bucket Strategy

**Existing Buckets (Leveraged):**
- **`products`** (public) - Use for product catalog images via existing `photos_paths` column
- **`attachments`** (public) - Use for deal line item photos via existing `photo_path` column

**New Buckets Added:**
```sql
-- Two new private buckets for proposal system
INSERT INTO storage.buckets (id, name, public) VALUES 
    ('proposal-images', 'proposal-images', false),    -- Proposal-specific custom images
    ('proposal-pdfs', 'proposal-pdfs', false);        -- Generated proposal PDFs
```

#### Image Path Strategy

**Products Table:**
- `photos_paths text[]` - Array of paths in existing `products` bucket (public)
- Example: `['products/lighting/downlight-brass-001.jpg', 'products/lighting/downlight-brass-002.jpg']`

**Deal Line Items:**
- `photo_path text` - Single image path in existing `attachments` bucket (public)

**Proposal Line Items:**
- `image_paths text[]` - Can reference existing product images or new proposal-specific images
- Allows customization per proposal without affecting product catalog

#### File Organization Structure
```
product-images/
├── categories/
│   ├── lighting/
│   ├── irrigation/
│   ├── plants/
│   └── maintenance/
└── products/
    ├── {product_id}/
    │   ├── primary.jpg
    │   ├── detail-001.jpg
    │   └── installation.jpg

proposal-images/
├── proposals/
│   ├── {proposal_id}/
│   │   ├── custom-diagram.jpg
│   │   └── site-specific.jpg
└── templates/
    ├── logos/
    └── backgrounds/

proposal-pdfs/
├── proposals/
│   ├── {proposal_id}/
│   │   ├── proposal-v1.pdf
│   │   ├── proposal-v2.pdf
│   │   └── final-proposal.pdf
└── templates/
    └── sample-proposals/
```

### 4. Enhanced Views and Functions

#### Products Proposal Summary View
```sql
CREATE VIEW public.products_proposal_summary AS
SELECT 
    p.*,
    COUNT(DISTINCT pli.id) as times_used_in_proposals,
    SUM(pli.quantity) as total_quantity_proposed,
    AVG(pli.unit_price) as avg_proposal_price,
    MAX(pli.created_at) as last_used_in_proposal
FROM public.products p
LEFT JOIN public.proposal_line_items pli ON p.id = pli.product_id
WHERE p.is_proposal_visible = true
GROUP BY p.id;
```

#### Automatic Calculation Function
```sql
CREATE FUNCTION public.recalculate_proposal_totals(proposal_id_param bigint)
RETURNS void AS $$
-- Automatically recalculates subtotal, tax, and total
-- Based on client-selected line items
-- Triggered on line item changes
$$;
```

### 5. Integration with Existing Schema

#### Deal Line Items Compatibility
The existing `deal_line_items` table (referenced in products enhancement migration) will work alongside the new proposal system:

- **Deal Line Items**: Simple line items for basic deal tracking
- **Proposal Line Items**: Enhanced line items with client interaction, sections, images
- **Migration Path**: Proposals can be generated from existing deal line items

#### Properties Integration
Proposals can reference properties for service location context:
```sql
-- Add property reference to proposals (optional)
ALTER TABLE public.proposals 
ADD COLUMN property_id bigint REFERENCES public.properties(id);
```

#### Jobs Integration
Won proposals can automatically create jobs:
```sql
-- Jobs can reference the original proposal
ALTER TABLE public.jobs 
ADD COLUMN proposal_id bigint REFERENCES public.proposals(id);
```

## Implementation Benefits

### 1. PandaDoc-Level Functionality
- **Section-based organization** with show/hide controls
- **Client-interactive proposals** with optional item selection
- **Real-time pricing calculations** with tax handling
- **Professional presentation** with branding and images

### 2. Elite Landscaping Specific Features
- **Service location integration** via properties
- **Recurring service pricing** (monthly maintenance)
- **Internal cost tracking** for profit margin analysis
- **Texas tax rate defaults** (8.25%)

### 3. Scalability and Performance
- **Indexed queries** for fast proposal loading
- **JSONB storage** for flexible proposal data
- **Automatic calculations** via database triggers
- **Efficient image storage** with CDN-ready buckets

## Migration Strategy

### Phase 1: Core Tables (Week 1)
1. Run the provided migration: `20250823143000_proposal_builder_system.sql`
2. Verify table creation and RLS policies
3. Test basic CRUD operations

### Phase 2: Image Storage Setup (Week 1)
1. Configure storage buckets and policies
2. Upload sample product images
3. Test image upload/retrieval workflows

### Phase 3: Data Population (Week 2)
1. Populate products with proposal-specific data
2. Create default proposal template
3. Generate sample proposals from existing deals

### Phase 4: Frontend Integration (Weeks 3-4)
1. Build React-Admin resources for proposals
2. Implement product catalog modal
3. Create proposal builder interface

## Security Considerations

### Row Level Security (RLS)
All new tables include comprehensive RLS policies:
- **Authenticated users**: Full CRUD access (can be refined later)
- **Future enhancement**: User-specific access based on `sales_id`

### Image Storage Security
- **Private buckets**: All image buckets are private by default
- **Authenticated access**: Only authenticated users can access images
- **Signed URLs**: Generate time-limited URLs for client access

### Data Privacy
- **Internal costs**: Never exposed to client-facing views
- **Client data separation**: Client selections stored separately from internal data

## Performance Optimizations

### Database Indexes
- **Proposal lookups**: `deal_id`, `status`, `created_at`
- **Line item queries**: `proposal_id`, `section_name`, `sort_order`
- **Product catalog**: `proposal_category`, `is_proposal_visible`

### Calculation Efficiency
- **Generated columns**: `total_price` calculated automatically
- **Trigger-based updates**: Proposal totals updated on line item changes
- **View-based summaries**: Pre-calculated aggregations for dashboards

## Conclusion

This schema provides a comprehensive foundation for a proposal builder system that rivals PandaDoc while being perfectly tailored to Elite Landscaping's workflows. The design emphasizes:

1. **Professional client experience** with interactive proposals
2. **Operational efficiency** with automated calculations and workflows  
3. **Business intelligence** with cost tracking and proposal analytics
4. **Scalability** with flexible JSONB storage and efficient indexing

The migration is ready for implementation and includes all necessary tables, indexes, policies, and default data to get started immediately.
